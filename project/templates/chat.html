<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Чат</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        #chat { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .message { margin: 8px 0; }
        .username { font-weight: bold; color: #2c3e50; }
        .notification { color: #7f8c8d; font-style: italic; }
        #loginForm, #chatForm { display: flex; gap: 10px; margin-top: 10px; }
        input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; }
        button { padding: 8px 16px; background: #3498db; color: white; border: none; cursor: pointer; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <h1>FastAPI WebSocket Чат</h1>
    
    <div id="loginSection">
        <div id="loginForm">
            <input type="text" id="usernameInput" placeholder="Ваше имя" required>
            <button onclick="connectToChat()">Войти в чат</button>
        </div>
    </div>
    
    <div id="chatSection" style="display: none;">
        <div id="chat"></div>
        <div id="chatForm">
            <input type="text" id="messageInput" placeholder="Ваше сообщение" disabled>
            <button onclick="sendMessage()" disabled>Отправить</button>
        </div>
    </div>

    <script>
        let socket;
        let currentUsername;
        
        function connectToChat() {
            const username = document.getElementById("usernameInput").value.trim();
            if (!username) return alert("Введите имя");
            
            currentUsername = username;
            socket = new WebSocket(`ws://${window.location.host}/ws`);
            
            socket.onopen = () => {
                // Первым сообщением отправляем имя пользователя
                socket.send(username);
                
                document.getElementById("loginSection").style.display = "none";
                document.getElementById("chatSection").style.display = "block";
                document.getElementById("messageInput").disabled = false;
                document.querySelector("#chatForm button").disabled = false;
                document.getElementById("messageInput").focus();
            };
            
            socket.onmessage = (event) => {
                const chat = document.getElementById("chat");
                const messageDiv = document.createElement("div");
                
                if (event.data.includes("присоединился") || event.data.includes("покинул")) {
                    messageDiv.className = "notification";
                    messageDiv.textContent = event.data;
                } else {
                    messageDiv.className = "message";
                    const [username, ...messageParts] = event.data.split(": ");
                    messageDiv.innerHTML = `
                        <span class="username">${username}:</span> ${messageParts.join(": ")}
                    `;
                }
                
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
            };
            
            socket.onclose = () => {
                alert("Соединение с сервером прервано");
                location.reload();
            };
            
            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
            };
        }
        
        function sendMessage() {
            const input = document.getElementById("messageInput");
            const message = input.value.trim();
            
            if (message && socket && socket.readyState === WebSocket.OPEN) {
                socket.send(message);
                input.value = "";
            }
        }
        
        // Отправка по Enter
        document.getElementById("messageInput").addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                sendMessage();
            }
        });
    </script>
</body>
</html>
